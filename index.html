<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>24V Battery Assessment Report Tool</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load required libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .report-section {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .score-button {
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .score-button:hover {
            opacity: 0.9;
        }
        .selected-score {
            outline: 3px solid #4f46e5;
            outline-offset: 1px;
        }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">

        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h1 class="text-3xl font-bold text-gray-800">24V Battery Assessment Report</h1>
        </div>
        <p class="text-gray-600 mb-8">Fill out the details below and click "Download PDF" to save the report.</p>

        <!-- Status Message Area -->
        <div id="status_message" class="mt-4 mb-4 p-3 hidden rounded-lg text-sm transition-all duration-300 flex items-center justify-between">
            <span></span>
            <div id="loading_spinner" class="spinner hidden ml-4"></div>
        </div>

        <!-- The main report content container for PDF generation -->
        <div id="report-content" class="space-y-8">

            <!-- 1. Battery Identification & Rating -->
            <div class="report-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">1. Identification & Rating</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label class="block">
                        <span class="text-gray-700">Assessment Date</span>
                        <input type="date" id="assessment_date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" required>
                    </label>
                    <label class="block">
                        <span class="text-gray-700">Assessor Name</span>
                        <input type="text" id="assessor_name" placeholder="John Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" required>
                    </label>
                    <label class="block md:col-span-2">
                        <span class="text-gray-700 font-bold">Battery Serial Number (S/N)</span>
                        <input type="text" id="serial_number" placeholder="BATT-24V-00123" class="mt-1 block w-full rounded-md border-indigo-500 shadow-sm p-2 text-lg font-mono font-bold text-black" required>
                    </label>
                    <label class="block">
                        <span class="text-gray-700">Battery Type</span>
                        <input type="text" id="battery_type" placeholder="LiFePO4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium">
                    </label>
                    <label class="block">
                        <span class="text-gray-700 font-bold">Nominal Ah Capacity (Ah)</span>
                        <input type="number" step="1" id="nominal_ah" placeholder="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" required>
                    </label>
                </div>

                <!-- Image Uploads -->
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Battery Physical Photo</h3>
                        <input type="file" id="photo_battery" accept="image/*" capture="environment" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <div id="preview_battery" class="mt-3 h-32 w-full bg-gray-100 rounded-lg flex items-center justify-center text-sm text-gray-400 overflow-hidden border border-gray-200">
                            <span class="text-gray-400">Image Preview</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-2">Rating Screenshot (e.g., BMS App)</h3>
                        <input type="file" id="photo_rating" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <div id="preview_rating" class="mt-3 h-32 w-full bg-gray-100 rounded-lg flex items-center justify-center text-sm text-gray-400 overflow-hidden border border-gray-200">
                             <span class="text-gray-400">Image Preview</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Electrical Consistency Analysis -->
            <div class="report-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">2. Electrical Consistency Analysis</h2>

                <div class="grid grid-cols-3 gap-4 font-semibold text-sm mb-2 p-2 border-b border-gray-200">
                    <p>Metric</p>
                    <p class="text-center">Value</p>
                    <p class="text-right">Score</p>
                </div>

                <!-- 2.1 Voltage Consistency - OCV -->
                <div class="grid grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg mb-4 score-row">
                    <p class="font-medium">Open-Circuit Voltage (OCV) [V]</p>
                    <input type="number" step="0.01" id="ocv_value" placeholder="26.5" class="rounded-md border-gray-300 shadow-sm p-1 text-sm mx-auto text-center w-24 font-bold text-black">
                    <div class="flex space-x-2 justify-end" data-category="ocv">
                        <button type="button" data-score="2" class="score-button bg-green-200 text-green-800 p-2 rounded-lg text-xs">Good (2)</button>
                        <button type="button" data-score="1" class="score-button bg-yellow-200 text-yellow-800 p-2 rounded-lg text-xs">Acceptable (1)</button>
                        <button type="button" data-score="0" class="score-button bg-red-200 text-red-800 p-2 rounded-lg text-xs">Poor (0)</button>
                        <input type="hidden" name="ocv_score_input" value="2">
                    </div>
                </div>

                <!-- 2.1 Voltage Consistency - Spread -->
                <div class="grid grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg score-row">
                    <p class="font-medium">Voltage Spread Across Cells [mV]</p>
                    <input type="number" id="volt_spread_value" placeholder="15" class="rounded-md border-gray-300 shadow-sm p-1 text-sm mx-auto text-center w-24 font-bold text-black">
                    <div class="flex space-x-2 justify-end" data-category="volt_spread">
                        <button type="button" data-score="2" class="score-button bg-green-200 text-green-800 p-2 rounded-lg text-xs">Good (2)</button>
                        <button type="button" data-score="1" class="score-button bg-yellow-200 text-yellow-800 p-2 rounded-lg text-xs">Acceptable (1)</button>
                        <button type="button" data-score="0" class="score-button bg-red-200 text-red-800 p-2 rounded-lg text-xs">Poor (0)</button>
                        <input type="hidden" name="volt_spread_score_input" value="2">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 font-semibold text-sm mb-2 mt-6 p-2 border-b border-gray-200">
                    <p>Metric</p>
                    <p class="text-center">Value</p>
                    <p class="text-right">Score</p>
                </div>

                <!-- 2.2 Internal Resistance Consistency - Avg -->
                <div class="grid grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg mb-4 score-row">
                    <p class="font-medium">Average Resistance [mΩ]</p>
                    <input type="number" step="0.01" id="avg_res_value" placeholder="2.5" class="rounded-md border-gray-300 shadow-sm p-1 text-sm mx-auto text-center w-24 font-bold text-black">
                    <div class="flex space-x-2 justify-end" data-category="avg_res">
                        <button type="button" data-score="2" class="score-button bg-green-200 text-green-800 p-2 rounded-lg text-xs">Good (2)</button>
                        <button type="button" data-score="1" class="score-button bg-yellow-200 text-yellow-800 p-2 rounded-lg text-xs">Acceptable (1)</button>
                        <button type="button" data-score="0" class="score-button bg-red-200 text-red-800 p-2 rounded-lg text-xs">Poor (0)</button>
                        <input type="hidden" name="avg_res_score_input" value="2">
                    </div>
                </div>

                <!-- 2.2 Internal Resistance Consistency - Spread -->
                <div class="grid grid-cols-3 gap-4 items-center p-3 bg-gray-50 rounded-lg score-row">
                    <p class="font-medium">Resistance Spread [mΩ]</p>
                    <input type="number" id="res_spread_value" placeholder="0.5" class="rounded-md border-gray-300 shadow-sm p-1 text-sm mx-auto text-center w-24 font-bold text-black">
                    <div class="flex space-x-2 justify-end" data-category="res_spread">
                        <button type="button" data-score="2" class="score-button bg-green-200 text-green-800 p-2 rounded-lg text-xs">Good (2)</button>
                        <button type="button" data-score="1" class="score-button bg-yellow-200 text-yellow-800 p-2 rounded-lg text-xs">Acceptable (1)</button>
                        <button type="button" data-score="0" class="score-button bg-red-200 text-red-800 p-2 rounded-lg text-xs">Poor (0)</button>
                        <input type="hidden" name="res_spread_score_input" value="2">
                    </div>
                </div>
            </div>

            <!-- 3 & 4. Tests -->
            <div class="report-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">3. Charge & 4. Discharge Tests</h2>

                <!-- Charge Test Details -->
                <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">3. Charge Test Details</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <label class="block col-span-1"><span class="text-gray-700">Voltage (V)</span><input type="number" step="0.1" id="charge_volt" placeholder="28.8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                        <label class="block col-span-1"><span class="text-gray-700">Current (A)</span><input type="number" step="0.1" id="charge_current" placeholder="50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                        <label class="block col-span-2"><span class="text-gray-700">Time to Full (HH:MM)</span><input type="text" id="charge_time" placeholder="03:45" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="font-medium text-gray-700">Result Score:</span>
                        <div class="flex space-x-4" data-category="charge_result">
                            <label class="inline-flex items-center"><input type="radio" name="charge_result_radio" value="PASS" data-score="2" class="form-radio text-green-600"><span class="ml-2 text-green-700 font-semibold">PASS (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="charge_result_radio" value="CAUTION" data-score="1" class="form-radio text-yellow-600"><span class="ml-2 text-yellow-700 font-semibold">CAUTION (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="charge_result_radio" value="FAIL" data-score="0" class="form-radio text-red-600"><span class="ml-2 text-red-700 font-semibold">FAIL (0)</span></label>
                            <input type="hidden" id="charge_score_input" value="0">
                        </div>
                    </div>
                </div>

                <!-- Discharge Test Details -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-xl font-medium text-gray-800 mb-3">4. Discharge Test Details</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <label class="block col-span-1"><span class="text-gray-700">Discharge Current (A)</span><input type="number" step="0.1" id="disch_current" placeholder="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                        <label class="block col-span-1"><span class="text-gray-700">EOD Voltage (V)</span><input type="number" step="0.1" id="disch_end_volt" placeholder="24.0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                        <label class="block col-span-1"><span class="text-gray-700">Temp (°C)</span><input type="number" id="ambient_temp" placeholder="25" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                        <label class="block col-span-1"><span class="text-gray-700 font-bold">Capacity Delivered (Ah)</span><input type="number" step="0.1" id="delivered_ah" placeholder="98.5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-bold"></label>
                    </div>

                    <div id="capacity_summary" class="mt-2 p-3 bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 rounded mb-4 font-semibold">
                        Capacity Delivered: **N/A** of **N/A Ah** (0.00%)
                    </div>

                    <div class="flex items-center space-x-4">
                        <span class="font-medium text-gray-700">Result Score:</span>
                        <div class="flex space-x-4" data-category="discharge_result">
                            <label class="inline-flex items-center"><input type="radio" name="discharge_result_radio" value="PASS" data-score="2" class="form-radio text-green-600"><span class="ml-2 text-green-700 font-semibold">PASS (2)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="discharge_result_radio" value="CAUTION" data-score="1" class="form-radio text-yellow-600"><span class="ml-2 text-yellow-700 font-semibold">CAUTION (1)</span></label>
                            <label class="inline-flex items-center"><input type="radio" name="discharge_result_radio" value="FAIL" data-score="0" class="form-radio text-red-600"><span class="ml-2 text-red-700 font-semibold">FAIL (0)</span></label>
                            <input type="hidden" id="discharge_score_input" value="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Summary & Evaluation -->
            <div class="report-section">
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">5. Summary & Evaluation</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Scoring Summary -->
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">5.1 Automatic Scoring</h3>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <div class="flex justify-between font-semibold border-b pb-1 mb-1 text-sm text-gray-600">
                                <span>Category</span>
                                <span>Score (Max)</span>
                            </div>
                            <div class="flex justify-between py-1"><span>Voltage Consistency</span><span id="score_voltage" class="font-mono text-black font-bold">0 / 4</span></div>
                            <div class="flex justify-between py-1"><span>Resistance Consistency</span><span id="score_resistance" class="font-mono text-black font-bold">0 / 4</span></div>
                            <div class="flex justify-between py-1"><span>Charge Test</span><span id="score_charge" class="font-mono text-black font-bold">0 / 2</span></div>
                            <div class="flex justify-between py-1"><span>Discharge Test</span><span id="score_discharge" class="font-mono text-black font-bold">0 / 2</span></div>
                            <div class="flex justify-between font-bold text-lg pt-2 border-t mt-2 text-indigo-700">
                                <span>TOTAL SCORE</span>
                                <span id="score_total" class="font-mono text-black font-bold">0 / 12</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Banding -->
                    <div>
                        <h3 class="text-xl font-medium text-gray-800 mb-3">5.2 Performance Banding</h3>
                        <ul id="banding_list" class="space-y-2 text-sm p-2 rounded-lg bg-gray-50">
                            <li data-range="10-12" class="p-2 rounded-md transition-colors duration-150">
                                <span class="font-semibold text-green-700">10 - 12 (Excellent):</span> Battery meets high-grade operational standards.
                            </li>
                            <li data-range="7-9" class="p-2 rounded-md transition-colors duration-150">
                                <span class="font-semibold text-yellow-700">7 - 9 (Acceptable):</span> Battery is serviceable with minor deviations.
                            </li>
                            <li data-range="0-6" class="p-2 rounded-md transition-colors duration-150">
                                <span class="font-semibold text-red-700">0 - 6 (Poor):</span> Battery not compliant; rejection required.
                            </li>
                        </ul>
                        <div class="mt-4 flex items-center space-x-6" id="overall_result">
                            <span class="font-bold text-gray-700">Overall Result:</span>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center"><input type="radio" name="overall_result_radio" value="PASS" class="form-radio text-green-600"><span class="ml-2 text-green-700 font-bold">PASS</span></label>
                                <label class="inline-flex items-center"><input type="radio" name="overall_result_radio" value="FAIL" class="form-radio text-red-600"><span class="ml-2 text-red-700 font-bold">FAIL</span></label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overall Evaluation -->
                <label class="block mt-6">
                    <span class="text-gray-700 font-medium">Reasoning for Overall Result:</span>
                    <textarea id="overall_reasoning" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" placeholder="e.g., Passed all tests with minimal resistance spread."></textarea>
                </label>
            </div>

            <!-- 6. Recommendations & Notes -->
            <div>
                <h2 class="text-2xl font-semibold text-indigo-700 mb-4">6. Recommendations & Notes</h2>
                <label class="block mb-4">
                    <span class="text-gray-700 font-medium">Suggested Actions:</span>
                    <textarea id="suggested_actions" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" placeholder="e.g., Accept for service. Monitor resistance spread monthly."></textarea>
                </label>
                <label class="block">
                    <span class="text-gray-700 font-medium">General Notes:</span>
                    <textarea id="general_notes" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-black font-medium" placeholder="Any other relevant observations during testing."></textarea>
                </label>
            </div>
        </div>
        <!-- End of report-content -->

        <div class="mt-8 pt-6 border-t border-gray-200">
            <button onclick="generatePDF()" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-150 ease-in-out flex items-center justify-center mx-auto" id="download_button">
                Download PDF Report
            </button>
        </div>
    </div>

    <script>
        // --- APP GLOBALS ---
        let batteryPhotoDataUrl = null;
        let ratingPhotoDataUrl = null;
        
        // --- UI/UX AND LOGIC ---

        function renderImagePreview(previewId, dataUrl) {
            const preview = document.getElementById(previewId);
            if (!preview) return;
            
            preview.innerHTML = '';
            if (dataUrl) {
                const img = document.createElement('img');
                img.src = dataUrl;
                img.className = 'w-full h-full object-cover';
                preview.appendChild(img);
            } else {
                preview.innerHTML = '<span class="text-gray-400">Image Preview</span>';
            }
        }

        function setupImageInput(inputId, previewId, dataUrlCallback) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            input.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        dataUrlCallback(e.target.result);
                        renderImagePreview(previewId, e.target.result);
                    }
                    reader.readAsDataURL(this.files[0]);
                } else {
                    dataUrlCallback(null);
                    renderImagePreview(previewId, null);
                }
            });
        }
        
        function showStatus(message, isError = false, showSpinner = false) {
            const statusDiv = document.getElementById('status_message');
            const spinner = document.getElementById('loading_spinner');
            
            if (!statusDiv || !spinner) return;
            
            statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
            
            if (isError) {
                statusDiv.classList.add('bg-red-100', 'text-red-700');
            } else if (showSpinner) {
                statusDiv.classList.add('bg-blue-100', 'text-blue-700');
            } else {
                statusDiv.classList.add('bg-green-100', 'text-green-700');
            }
            
            const messageSpan = statusDiv.querySelector('span');
            if (messageSpan) messageSpan.textContent = message;
            else statusDiv.textContent = message;

            if (showSpinner) {
                 statusDiv.classList.add('flex', 'items-center', 'justify-between');
                 spinner.classList.remove('hidden');
            } else {
                 spinner.classList.add('hidden');
                 statusDiv.classList.remove('flex', 'items-center', 'justify-between');
            }
        }

        function updateCapacitySummary() {
            const deliveredAh = parseFloat(document.getElementById('delivered_ah')?.value) || 0;
            const nominalAh = parseFloat(document.getElementById('nominal_ah')?.value) || 1;
            let percentage = (deliveredAh / nominalAh) * 100;
            percentage = isNaN(percentage) ? 0 : Math.min(100, percentage).toFixed(2);

            const summaryElement = document.getElementById('capacity_summary');
            if (summaryElement) {
                summaryElement.innerHTML = `Capacity Delivered: <span class="text-indigo-600 font-bold">${deliveredAh.toFixed(1)} Ah</span> of <span class="text-indigo-600 font-bold">${nominalAh.toFixed(1)} Ah</span> (<span class="text-lg">${percentage}%</span>)`;
            }
        }

        function updateScoreSummary() {
            const getScore = (id) => parseInt(document.getElementById(id)?.value) || 0;
            
            const scores = {
                voltage_ocv: parseInt(document.querySelector('input[name="ocv_score_input"]')?.value) || 0,
                voltage_spread: parseInt(document.querySelector('input[name="volt_spread_score_input"]')?.value) || 0,
                resistance_avg: parseInt(document.querySelector('input[name="avg_res_score_input"]')?.value) || 0,
                resistance_spread: parseInt(document.querySelector('input[name="res_spread_score_input"]')?.value) || 0,
                charge: getScore('charge_score_input'),
                discharge: getScore('discharge_score_input'),
            };

            const totalVoltage = scores.voltage_ocv + scores.voltage_spread;
            const totalResistance = scores.resistance_avg + scores.resistance_spread;
            const totalScore = totalVoltage + totalResistance + scores.charge + scores.discharge;

            // Helper to safely update text
            const setText = (id, text) => {
                const el = document.getElementById(id);
                if(el) el.textContent = text;
            };

            setText('score_voltage', `${totalVoltage} / 4`);
            setText('score_resistance', `${totalResistance} / 4`);
            setText('score_charge', `${scores.charge} / 2`);
            setText('score_discharge', `${scores.discharge} / 2`);
            setText('score_total', `${totalScore} / 12`);

            document.querySelectorAll('#banding_list li').forEach(li => {
                li.classList.remove('bg-indigo-100', 'ring-2', 'ring-indigo-500');
                const range = li.getAttribute('data-range').split('-');
                const min = parseInt(range[0]);
                const max = parseInt(range[1]);

                if (totalScore >= min && totalScore <= max) {
                    li.classList.add('bg-indigo-100', 'ring-2', 'ring-indigo-500');
                }
            });
        }

        // --- PDF PREPARATION FUNCTION ---
        function prepareForPdf() {
             const replacements = [];
             const container = document.getElementById('report-content');

             // 1. Replace Input Fields and Textareas with DIVs for visibility
             const inputs = container.querySelectorAll('input:not([type="hidden"]), textarea');
             inputs.forEach(input => {
                 if(input.type === 'file' || input.type === 'radio' || input.type === 'checkbox') return;
                 
                 const div = document.createElement('div');
                 // Robust block styling to ensure visibility in html2canvas
                 div.className = 'mt-1 block w-full text-lg font-bold text-black p-1 border-b border-gray-300'; 
                 div.textContent = input.value || '-';
                 
                 input.style.display = 'none';
                 input.parentNode.insertBefore(div, input);
                 replacements.push({ el: input, replacement: div, type: 'input' });
             });

             // 2. Handle Score Buttons (Replace groups with text)
             const scoreGroups = container.querySelectorAll('div[data-category]');
             scoreGroups.forEach(group => {
                 const category = group.getAttribute('data-category');
                 
                 // For score buttons:
                 const selectedBtn = group.querySelector('.selected-score');
                 let text = "";
                 let colorClass = "text-gray-500";

                 if(selectedBtn) {
                     text = selectedBtn.textContent;
                     if(text.includes('Good')) colorClass = 'text-green-700 font-bold';
                     else if(text.includes('Acceptable')) colorClass = 'text-yellow-700 font-bold';
                     else if(text.includes('Poor')) colorClass = 'text-red-700 font-bold';
                 } else {
                     // Check for radios inside this group (Charge/Discharge)
                     const checkedRadio = group.querySelector('input[type="radio"]:checked');
                     if(checkedRadio) {
                        const label = checkedRadio.parentNode.querySelector('span');
                        text = label ? label.textContent : checkedRadio.value;
                         if(text.includes('PASS')) colorClass = 'text-green-700 font-bold';
                         else if(text.includes('CAUTION')) colorClass = 'text-yellow-700 font-bold';
                         else if(text.includes('FAIL')) colorClass = 'text-red-700 font-bold';
                     }
                 }
                 
                 if (text) {
                    const div = document.createElement('div');
                    div.className = `text-right text-lg ${colorClass}`;
                    div.textContent = text;
    
                    group.style.display = 'none';
                    group.parentNode.insertBefore(div, group);
                    replacements.push({ el: group, replacement: div, type: 'group' });
                 }
             });

             // 3. Handle Overall Result (Special ID case)
             const overallGroup = document.getElementById('overall_result');
             if(overallGroup) {
                 const checkedRadio = overallGroup.querySelector('input[type="radio"]:checked');
                 let text = "";
                 let colorClass = "text-gray-500";
                 if(checkedRadio) {
                     if(checkedRadio.value === 'PASS') {
                         text = "PASS";
                         colorClass = "text-green-700 font-bold text-2xl";
                     } else {
                         text = "FAIL";
                         colorClass = "text-red-700 font-bold text-2xl";
                     }
                     
                     const div = document.createElement('div');
                     div.className = `ml-4 ${colorClass}`;
                     div.textContent = text;
                     
                     // Hide the original radio group container
                     const radioContainer = overallGroup.querySelector('.flex');
                     if(radioContainer) {
                        radioContainer.style.display = 'none';
                        overallGroup.appendChild(div);
                        replacements.push({ el: radioContainer, replacement: div, type: 'group' });
                     }
                 }
             }

             return replacements;
        }

        function restoreFromPdf(replacements) {
            replacements.forEach(item => {
                if(item.type === 'input') {
                    item.el.style.display = ''; 
                    item.replacement.remove(); 
                } else if(item.type === 'group') {
                    item.el.style.display = ''; 
                    item.replacement.remove();
                }
            });
        }


        // Main function to generate and save the PDF
        async function generatePDF() {
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF !== 'function') {
                showStatus('Error: PDF library not loaded. Please refresh the page.', true);
                return;
            }

            const serialNumber = document.getElementById('serial_number')?.value.trim();
            if (!serialNumber) {
                showStatus('Error: Please enter the Battery Serial Number before generating the report.', true);
                return;
            }

            const downloadButton = document.getElementById('download_button');
            if(downloadButton) downloadButton.disabled = true;
            showStatus('Generating PDF report... Please wait.', false, true);

            // 1. Transform Form for Printing
            const replacements = prepareForPdf();
            
            // Hide Controls
            const controlsToHide = document.querySelectorAll('button, .file-input-ui');
            controlsToHide.forEach(el => el.style.visibility = 'hidden');

            const input = document.getElementById('report-content');

            try {
                await new Promise(resolve => setTimeout(resolve, 200)); // Slightly longer delay for rendering
                
                const canvas = await html2canvas(input, { scale: 2, useCORS: true });
                const { jsPDF } = window.jspdf; 
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const contentHeight = (imgProps.height * pdfWidth) / imgProps.width; 
                
                // Multi-page logic
                let position = 0;
                while (position < contentHeight) {
                    if (position > 0) {
                        pdf.addPage();
                    }
                    pdf.addImage(imgData, 'PNG', 0, -position, pdfWidth, contentHeight);
                    position += pdfHeight;
                }

                // Add Photos Page
                if (batteryPhotoDataUrl || ratingPhotoDataUrl) {
                    pdf.addPage();
                    pdf.setFontSize(16);
                    pdf.text(`Battery Photos for S/N: ${serialNumber}`, 10, 15);
                    pdf.setFontSize(10);
                    
                    let currentY = 25;
                    const photoWidth = 180;
                    const photoMargin = 10;

                    const getImageDimensions = (dataUrl, targetWidth) => {
                        return new Promise(resolve => {
                            const img = new Image();
                            img.onload = () => {
                                const aspectRatio = img.height / img.width;
                                resolve({ width: targetWidth, height: targetWidth * aspectRatio });
                            };
                            img.onerror = () => resolve({ width: 0, height: 0 });
                            img.src = dataUrl;
                        });
                    };

                    if (batteryPhotoDataUrl) {
                        pdf.text('1. Battery Physical Photo:', 10, currentY);
                        currentY += 5;
                        const { width: w1, height: h1 } = await getImageDimensions(batteryPhotoDataUrl, photoWidth);
                        pdf.addImage(batteryPhotoDataUrl, 'JPEG', 15, currentY, w1, h1);
                        currentY += h1 + photoMargin + 10;
                    }

                    if (ratingPhotoDataUrl) {
                        if (currentY > pdfHeight - 80) { pdf.addPage(); currentY = 20; }
                        pdf.text('2. Rating Screenshot:', 10, currentY);
                        currentY += 5;
                        const { width: w2, height: h2 } = await getImageDimensions(ratingPhotoDataUrl, photoWidth);
                        pdf.addImage(ratingPhotoDataUrl, 'JPEG', 15, currentY, w2, h2);
                    }
                }

                pdf.save(`${serialNumber}.pdf`);
                showStatus(`PDF downloaded successfully: ${serialNumber}.pdf`, false);
                
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showStatus('Error generating PDF. See console for details.', true);
            } finally {
                // Restore Form State
                restoreFromPdf(replacements);
                
                // Restore Controls
                controlsToHide.forEach(el => el.style.visibility = '');
                if(downloadButton) downloadButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('assessment_date').valueAsDate = new Date();

            // Initial score button states
            document.querySelectorAll('div[data-category]').forEach(container => {
                const category = container.getAttribute('data-category');
                const defaultScore = (['ocv', 'volt_spread', 'avg_res', 'res_spread'].includes(category)) ? 2 : 0;
                
                const hiddenInput = container.querySelector('input[type="hidden"]');
                if (hiddenInput) hiddenInput.value = defaultScore;

                const defaultButton = container.querySelector(`button[data-score="${defaultScore}"]`);
                if (defaultButton) defaultButton.classList.add('selected-score');
            });

            // Input handlers for capacity summary
            document.getElementById('nominal_ah')?.addEventListener('input', updateCapacitySummary);
            document.getElementById('delivered_ah')?.addEventListener('input', updateCapacitySummary);

            // Score button handlers
            document.querySelectorAll('button[data-score]').forEach(button => {
                button.addEventListener('click', function() {
                    const container = this.closest('div[data-category]');
                    const score = parseInt(this.getAttribute('data-score'));
                    
                    const input = container.querySelector('input[type="hidden"]');
                    if (input) input.value = score;

                    container.querySelectorAll('.score-button').forEach(btn => btn.classList.remove('selected-score'));
                    this.classList.add('selected-score');

                    updateScoreSummary();
                });
            });

            // Radio button handlers
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const score = parseInt(this.getAttribute('data-score'));
                    const targetId = (this.name === 'charge_result_radio') ? 'charge_score_input' : 
                                     (this.name === 'discharge_result_radio') ? 'discharge_score_input' : null;
                    
                    if (targetId) {
                        document.getElementById(targetId).value = score;
                        updateScoreSummary();
                    }
                });
            });
            
            setupImageInput('photo_battery', 'preview_battery', (url) => batteryPhotoDataUrl = url);
            setupImageInput('photo_rating', 'preview_rating', (url) => ratingPhotoDataUrl = url);

            updateCapacitySummary();
            updateScoreSummary();
        });
    </script>

</body>
</html>